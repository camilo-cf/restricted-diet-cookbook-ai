name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SMOKE (Fail Fast < 2m)
  # ------------------------------------------------------------------
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: 1. Contract Validation
        run: |
          npm install -g @stoplight/spectral-cli
          spectral lint openapi.yaml --ruleset https://raw.githubusercontent.com/stoplightio/spectral-standard/main/rulesets/.spectral.yaml || echo "Warning: using default rules"

      - name: 2. Client Freshness Check
        run: pnpm client:check

      - name: 3. Frontend Build Check
        run: |
          cd apps/web
          pnpm build
          
      - name: 4. Backend Boot & Health Check
        run: |
          # Build and start minimal stack
          docker compose up -d db backend
          
          # Wait for health (max 60s)
          timeout=60
          while [ $timeout -gt 0 ]; do
            if curl -s http://localhost:8000/health | grep "ok" > /dev/null; then
              echo "✅ Backend Healthy"
              exit 0
            fi
            sleep 1
            timeout=$((timeout - 1))
          done
          
          echo "❌ Backend failed to boot"
          docker compose logs backend
          exit 1

  # ------------------------------------------------------------------
  # JOB 2: FULL TESTS (Expensive)
  # ------------------------------------------------------------------
  full-tests:
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start Full Stack
        run: docker compose up -d db minio backend frontend

      - name: Run Backend Tests
        run: docker compose exec -T backend pytest

      - name: Run Frontend Tests
        run: |
           # Install Playwright browsers (if running local/non-docker E2E, 
           # but we use run.sh test which might use docker. 
           # Let's use the containerized approach from run.sh test)
           # Actually, for CI let's be explicit:
           docker compose exec -T frontend pnpm test

  # ------------------------------------------------------------------
  # JOB 3: DEPLOY (Delivery)
  # ------------------------------------------------------------------
  deploy:
    needs: full-tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            curl "$RENDER_DEPLOY_HOOK"
          else
            echo "⚠️ RENDER_DEPLOY_HOOK not set, skipping deploy trigger."
          fi
